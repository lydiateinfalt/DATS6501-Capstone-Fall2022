# -*- coding: utf-8 -*-
"""UrbanAreas_tutorials.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1-WZuk9CiRyXvJispRaEgeUqUzFyxc-Bx

pip install gdal
pip install geopandas
pip install rasterio
pip install geojson
pip install json
pip install GOSTRocks
"""

import geopandas as gpd
import rasterio
import sys, os, importlib
import rasterio
import src.UrbanRaster as urban

# from google.colab import drive
# drive.mount('/content/drive')

sys.path.append("../../")
#sys.path.append("/content/drive/My Drive/Colab Notebooks/")
#os.chdir('/content/drive/MyDrive/Colab Notebooks/GOST_Urban/')

# Define input population raster
output_folder = "/content/drive/MyDrive/Colab Notebooks/GOST_Urban/data/Output"
data_folder = "/content/drive/MyDrive/Colab Notebooks/GOST_Urban/data/"
aoi_file = os.path.join(data_folder, "Sindh_Province.geojson")
pop_file = os.path.join(data_folder, "pak1k_gpo.tif")
out_urban = os.path.join(output_folder, "urban_extents.geojson")
out_hd_urban = os.path.join(output_folder, "hd_urban_extents.geojson")

inAOI = gpd.read_file(aoi_file)

# Shouldn't need to execute this unless you change your AOI
if not os.path.exists(pop_file):
    sys.path.append("../../../gostrocks/src")
    import GOSTRocks.rasterMisc as rMisc
    global_population = "/content/drive/MyDrive/Colab Notebooks/GOST_Urban/data/ppp_2020_1km_Aggregated.tif"
    inR = rasterio.open(global_population)
    rMisc.clipRaster(inR, inAOI, pop_file)
    
inR = rasterio.open(pop_file)

# calculate urban
urban_calculator = urban.urbanGriddedPop(inR)
urban_calculator.calculateUrban

urban_extents = urban_calculator.calculateUrban(densVal=300, totalPopThresh=5000, 
                                               smooth=False, queen=False,
                                               verbose=True)

hd_urban_extents = urban_calculator.calculateUrban(densVal=1500, totalPopThresh=50000, 
                                               smooth=True, queen=True,
                                               verbose=True)

output_folder = "/content/drive/MyDrive/Colab Notebooks/GOST_Urban/data/Output"
out_urban = os.path.join(output_folder, "urban_extents.geojson")
out_hd_urban = os.path.join(output_folder, "hd_urban_extents.geojson")

urban_extents.to_file(out_urban, driver="GeoJSON")
hd_urban_extents.to_file(out_hd_urban, driver="GeoJSON")

hd_urban_ext = '/content/drive/MyDrive/Colab Notebooks/GOST_Urban/data/Input Data Urban Calculations/FINAL_STANDARD_1KM/hd_urban_extents.geojson'
hd_urban = gpd.read_file(hd_urban_ext)
print(hd_urban.head())